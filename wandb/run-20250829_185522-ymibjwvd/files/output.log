W&B online run started. URL: https://wandb.ai/ttl/tpu-vit/runs/ymibjwvd
TPU mode: Using num_workers=0 to avoid pickle issues, will use MpDeviceLoader for parallelism
Mixup is activated!
WARNING:timm.models._builder:No pretrained configuration specified for my_vit_b model. Using a default. Please add a config to the model pretrained_cfg registry or pass explicitly.
Forcing XLA synchronization after model.to(device)...
XLA mark_step() after model.to(device) completed
Forcing XLA synchronization before parameter counting...
XLA mark_step() completed
TPU spawned process: world_size = 64
Calculated total_batch_size = 16384
Number of training examples = 1281167
LR = 0.00400000
Batch size = 16384
Update frequent = 1
Number of training steps per epoch = 78
TPU multihost mode: XLA handles data distribution internally
About to create optimizer...
TPU mode: Using name-only parameter grouping to avoid XLA compilation
TPU mode: Collecting parameter names...
TPU mode: Found 152 trainable parameters
TPU mode: Grouping parameters by names...
Processing parameter 1/152: cls_token
Processing parameter 51/152: blocks.3.mlp.fc2.weight
Processing parameter 101/152: blocks.8.norm1.weight
Processing parameter 151/152: head.weight
TPU mode: Parameter names grouped successfully
TPU mode: Mapping names to tensors...
TPU mode: All 152 parameters mapped successfully
Parameter iteration completed! Processed 152 parameters.
TPU mode: Created 2 parameter groups, returning optimizer groups...
Parameter groups created successfully
Optimizer created successfully
TPU mode: Skipping loss scaler (XLA handles mixed precision)
TPU mode: About to set loss_scaler = None...
TPU mode: Loss scaler set to None
About to create Cosine LR scheduler...
Set warmup steps = 1560
LR scheduler created successfully
About to continue to weight decay scheduler...
About to check args.weight_decay_end...
Directly setting weight_decay_end to avoid freeze...
weight_decay_end set to: 0.05
About to call cosine_scheduler for weight decay...
Calling with: wd=0.05, wd_end=0.05, epochs=100, steps_per_epoch=78
Set warmup steps = 0
cosine_scheduler completed, about to calculate min/max...
Weight decay schedule created: 0.05 -> 0.05
About to create criterion...
Created SoftTargetCrossEntropy criterion
criterion = SoftTargetCrossEntropy()
TPU mode: Skipping warmup (caused shape errors), will compile on first iteration
About to call auto_load_model...
auto_load_model completed
About to define get_eval_model helper function...
get_eval_model function defined
About to set max_accuracy...
max_accuracy initialized
🚀 Creating MpDeviceLoader for training DataLoader (TPU optimization)...
✅ Training MpDeviceLoader created successfully
🚀 Creating MpDeviceLoader for validation DataLoader (TPU optimization)...
✅ Validation MpDeviceLoader created successfully
Start training for 100 epochs
About to record start_time...
About to enter training loop...
Starting epoch 0 (delay since last epoch: 0.00s)...
Setting sampler epoch...
About to call original_train_sampler.set_epoch(0)...
✅ original_train_sampler.set_epoch(0) completed in 0.00s
Setting wandb steps...
About to call train_one_epoch...
🎯 train_one_epoch called for epoch 0
About to zero_grad optimizer...
About to start data loader loop...
TPU mode: Using direct DataLoader enumeration to avoid metric_logger overhead
🚀 Starting data_iter_step 0 (DataLoader iteration took 0.000s)...
Epoch: [0] [0/78] eta: 0:01:18 loss: 7.1250 lr: 0.000000 time: 34.4949 data: 0.0000
🚀 Starting data_iter_step 1 (DataLoader iteration took 10.219s)...
🚀 Starting data_iter_step 2 (DataLoader iteration took 13.139s)...
🚀 Starting data_iter_step 3 (DataLoader iteration took 0.175s)...
🚀 Starting data_iter_step 4 (DataLoader iteration took 0.651s)...
🚀 Starting data_iter_step 5 (DataLoader iteration took 0.607s)...
🚀 Starting data_iter_step 6 (DataLoader iteration took 0.626s)...
🚀 Starting data_iter_step 7 (DataLoader iteration took 0.640s)...
🚀 Starting data_iter_step 8 (DataLoader iteration took 1.035s)...
🚀 Starting data_iter_step 9 (DataLoader iteration took 0.639s)...
🚀 Starting data_iter_step 10 (DataLoader iteration took 0.225s)...
Epoch: [0] [10/78] eta: 0:00:39 loss: 7.0312 lr: 0.000026 time: 0.5860 data: 0.2252
🚀 Starting data_iter_step 11 (DataLoader iteration took 0.327s)...
🚀 Starting data_iter_step 12 (DataLoader iteration took 0.294s)...
🚀 Starting data_iter_step 13 (DataLoader iteration took 0.199s)...
🚀 Starting data_iter_step 14 (DataLoader iteration took 0.689s)...
🚀 Starting data_iter_step 15 (DataLoader iteration took 0.333s)...
🚀 Starting data_iter_step 16 (DataLoader iteration took 0.616s)...
🚀 Starting data_iter_step 17 (DataLoader iteration took 0.676s)...
🚀 Starting data_iter_step 18 (DataLoader iteration took 0.242s)...
🚀 Starting data_iter_step 19 (DataLoader iteration took 0.648s)...
🚀 Starting data_iter_step 20 (DataLoader iteration took 0.651s)...
Epoch: [0] [20/78] eta: 0:00:37 loss: 7.0312 lr: 0.000051 time: 0.6517 data: 0.6511
🚀 Starting data_iter_step 21 (DataLoader iteration took 0.215s)...
🚀 Starting data_iter_step 22 (DataLoader iteration took 0.210s)...
🚀 Starting data_iter_step 23 (DataLoader iteration took 0.637s)...
🚀 Starting data_iter_step 24 (DataLoader iteration took 0.596s)...
🚀 Starting data_iter_step 25 (DataLoader iteration took 0.203s)...
🚀 Starting data_iter_step 26 (DataLoader iteration took 0.649s)...
🚀 Starting data_iter_step 27 (DataLoader iteration took 0.263s)...
🚀 Starting data_iter_step 28 (DataLoader iteration took 0.577s)...
🚀 Starting data_iter_step 29 (DataLoader iteration took 0.587s)...
🚀 Starting data_iter_step 30 (DataLoader iteration took 0.253s)...
Epoch: [0] [30/78] eta: 0:00:12 loss: 7.0000 lr: 0.000077 time: 0.2679 data: 0.2529
🚀 Starting data_iter_step 31 (DataLoader iteration took 0.601s)...
🚀 Starting data_iter_step 32 (DataLoader iteration took 0.272s)...
🚀 Starting data_iter_step 33 (DataLoader iteration took 0.355s)...
🚀 Starting data_iter_step 34 (DataLoader iteration took 0.242s)...
🚀 Starting data_iter_step 35 (DataLoader iteration took 0.239s)...
🚀 Starting data_iter_step 36 (DataLoader iteration took 0.707s)...
🚀 Starting data_iter_step 37 (DataLoader iteration took 0.687s)...
🚀 Starting data_iter_step 38 (DataLoader iteration took 0.289s)...
🚀 Starting data_iter_step 39 (DataLoader iteration took 0.258s)...
🚀 Starting data_iter_step 40 (DataLoader iteration took 0.582s)...
Epoch: [0] [40/78] eta: 0:00:10 loss: 7.0000 lr: 0.000103 time: 0.2687 data: 0.5824
🚀 Starting data_iter_step 41 (DataLoader iteration took 0.617s)...
🚀 Starting data_iter_step 42 (DataLoader iteration took 0.247s)...
🚀 Starting data_iter_step 43 (DataLoader iteration took 0.247s)...
🚀 Starting data_iter_step 44 (DataLoader iteration took 0.624s)...
🚀 Starting data_iter_step 45 (DataLoader iteration took 0.227s)...
🚀 Starting data_iter_step 46 (DataLoader iteration took 0.315s)...
🚀 Starting data_iter_step 47 (DataLoader iteration took 0.256s)...
🚀 Starting data_iter_step 48 (DataLoader iteration took 0.258s)...
🚀 Starting data_iter_step 49 (DataLoader iteration took 1.419s)...
🚀 Starting data_iter_step 50 (DataLoader iteration took 0.262s)...
Epoch: [0] [50/78] eta: 0:00:19 loss: 7.0000 lr: 0.000128 time: 0.6934 data: 0.2616
🚀 Starting data_iter_step 51 (DataLoader iteration took 0.208s)...
🚀 Starting data_iter_step 52 (DataLoader iteration took 0.558s)...
🚀 Starting data_iter_step 53 (DataLoader iteration took 0.574s)...
🚀 Starting data_iter_step 54 (DataLoader iteration took 0.239s)...
🚀 Starting data_iter_step 55 (DataLoader iteration took 0.236s)...
🚀 Starting data_iter_step 56 (DataLoader iteration took 4.634s)...
🚀 Starting data_iter_step 57 (DataLoader iteration took 1.955s)...
🚀 Starting data_iter_step 58 (DataLoader iteration took 0.602s)...
🚀 Starting data_iter_step 59 (DataLoader iteration took 0.646s)...
🚀 Starting data_iter_step 60 (DataLoader iteration took 0.576s)...
Epoch: [0] [60/78] eta: 0:00:04 loss: 6.9688 lr: 0.000154 time: 0.2750 data: 0.5759
🚀 Starting data_iter_step 61 (DataLoader iteration took 0.620s)...
🚀 Starting data_iter_step 62 (DataLoader iteration took 0.744s)...
🚀 Starting data_iter_step 63 (DataLoader iteration took 0.259s)...
🚀 Starting data_iter_step 64 (DataLoader iteration took 4.213s)...
🚀 Starting data_iter_step 65 (DataLoader iteration took 1.539s)...
🚀 Starting data_iter_step 66 (DataLoader iteration took 0.584s)...
🚀 Starting data_iter_step 67 (DataLoader iteration took 0.577s)...
🚀 Starting data_iter_step 68 (DataLoader iteration took 0.345s)...
🚀 Starting data_iter_step 69 (DataLoader iteration took 0.672s)...
🚀 Starting data_iter_step 70 (DataLoader iteration took 0.319s)...
Epoch: [0] [70/78] eta: 0:00:04 loss: 7.0000 lr: 0.000180 time: 0.6001 data: 0.3185
🚀 Starting data_iter_step 71 (DataLoader iteration took 0.238s)...
🚀 Starting data_iter_step 72 (DataLoader iteration took 1.324s)...
🚀 Starting data_iter_step 73 (DataLoader iteration took 1.702s)...
🚀 Starting data_iter_step 74 (DataLoader iteration took 0.635s)...
🚀 Starting data_iter_step 75 (DataLoader iteration took 0.601s)...
🚀 Starting data_iter_step 76 (DataLoader iteration took 0.623s)...
🚀 Starting data_iter_step 77 (DataLoader iteration took 0.300s)...
Averaged stats: loss: 6.9688 (7.0256)  lr: 0.0002 (0.0001)
🏁 train_one_epoch total time: 399.14s
✅ Training epoch 0 completed in 399.14s
Checking checkpoint save conditions...
About to start validation...
Getting eval model...
About to call evaluate()...
Starting validation loop...
Validation DataLoader type: <class 'torch_xla.distributed.parallel_loader.MpDeviceLoader'>
Validation DataLoader batch count: 3
About to call enumerate(metric_logger.log_every(...)) for validation...
TPU mode: Using direct validation DataLoader enumeration to avoid metric_logger overhead
📊 First validation enumerate() call took 93.05s
🔍 Starting validation batch 0 (DataLoader iteration took 0.000s)...
Test: [0/3] loss: 6.9688 acc1: 0.2598 acc5: 1.0391 time: 8.9153 data: 0.0000
* Acc@1 0.176 Acc@5 0.832 loss 6.917
✅ Validation completed in 115.57s
Accuracy of the model on the 50000 test images: 0.2%
Max accuracy: 0.18%
🏁 Epoch 0 total time: 514.71s
Starting epoch 1 (delay since last epoch: 0.00s)...
Setting sampler epoch...
About to call original_train_sampler.set_epoch(1)...
✅ original_train_sampler.set_epoch(1) completed in 0.00s
Setting wandb steps...
About to call train_one_epoch...
🎯 train_one_epoch called for epoch 1
About to zero_grad optimizer...
About to start data loader loop...
TPU mode: Using direct DataLoader enumeration to avoid metric_logger overhead
🚀 Starting data_iter_step 0 (DataLoader iteration took 365.012s)...
Epoch: [1] [0/78] eta: 0:01:18 loss: 6.9375 lr: 0.000200 time: 0.6324 data: 365.0124
🚀 Starting data_iter_step 1 (DataLoader iteration took 8.787s)...
🚀 Starting data_iter_step 2 (DataLoader iteration took 0.365s)...
🚀 Starting data_iter_step 3 (DataLoader iteration took 0.261s)...
🚀 Starting data_iter_step 4 (DataLoader iteration took 0.670s)...
🚀 Starting data_iter_step 5 (DataLoader iteration took 0.667s)...
🚀 Starting data_iter_step 6 (DataLoader iteration took 0.352s)...
🚀 Starting data_iter_step 7 (DataLoader iteration took 0.371s)...
🚀 Starting data_iter_step 8 (DataLoader iteration took 0.606s)...
🚀 Starting data_iter_step 9 (DataLoader iteration took 5.613s)...
🚀 Starting data_iter_step 10 (DataLoader iteration took 0.246s)...
Epoch: [1] [10/78] eta: 0:00:38 loss: 6.9375 lr: 0.000226 time: 0.5590 data: 0.2457
🚀 Starting data_iter_step 11 (DataLoader iteration took 0.440s)...
🚀 Starting data_iter_step 12 (DataLoader iteration took 0.626s)...
🚀 Starting data_iter_step 13 (DataLoader iteration took 0.643s)...
🚀 Starting data_iter_step 14 (DataLoader iteration took 0.631s)...
🚀 Starting data_iter_step 15 (DataLoader iteration took 0.314s)...
🚀 Starting data_iter_step 16 (DataLoader iteration took 0.183s)...
🚀 Starting data_iter_step 17 (DataLoader iteration took 6.150s)...
🚀 Starting data_iter_step 18 (DataLoader iteration took 0.616s)...
🚀 Starting data_iter_step 19 (DataLoader iteration took 0.325s)...
🚀 Starting data_iter_step 20 (DataLoader iteration took 0.674s)...
Epoch: [1] [20/78] eta: 0:00:37 loss: 6.8750 lr: 0.000251 time: 0.6390 data: 0.6736
🚀 Starting data_iter_step 21 (DataLoader iteration took 0.255s)...
🚀 Starting data_iter_step 22 (DataLoader iteration took 0.663s)...
🚀 Starting data_iter_step 23 (DataLoader iteration took 0.174s)...
🚀 Starting data_iter_step 24 (DataLoader iteration took 0.608s)...
🚀 Starting data_iter_step 25 (DataLoader iteration took 5.417s)...
🚀 Starting data_iter_step 26 (DataLoader iteration took 0.601s)...
🚀 Starting data_iter_step 27 (DataLoader iteration took 0.348s)...
🚀 Starting data_iter_step 28 (DataLoader iteration took 0.654s)...
🚀 Starting data_iter_step 29 (DataLoader iteration took 0.270s)...
🚀 Starting data_iter_step 30 (DataLoader iteration took 0.280s)...
Epoch: [1] [30/78] eta: 0:00:13 loss: 6.8750 lr: 0.000277 time: 0.2709 data: 0.2804
🚀 Starting data_iter_step 31 (DataLoader iteration took 0.678s)...
🚀 Starting data_iter_step 32 (DataLoader iteration took 0.673s)...
🚀 Starting data_iter_step 33 (DataLoader iteration took 5.530s)...
🚀 Starting data_iter_step 34 (DataLoader iteration took 0.613s)...
🚀 Starting data_iter_step 35 (DataLoader iteration took 0.672s)...
🚀 Starting data_iter_step 36 (DataLoader iteration took 0.598s)...
🚀 Starting data_iter_step 37 (DataLoader iteration took 0.634s)...
🚀 Starting data_iter_step 38 (DataLoader iteration took 0.263s)...
🚀 Starting data_iter_step 39 (DataLoader iteration took 0.308s)...
🚀 Starting data_iter_step 40 (DataLoader iteration took 0.617s)...
Epoch: [1] [40/78] eta: 0:00:10 loss: 6.9375 lr: 0.000303 time: 0.2659 data: 0.6175
🚀 Starting data_iter_step 41 (DataLoader iteration took 5.726s)...
🚀 Starting data_iter_step 42 (DataLoader iteration took 0.370s)...
🚀 Starting data_iter_step 43 (DataLoader iteration took 0.633s)...
🚀 Starting data_iter_step 44 (DataLoader iteration took 0.695s)...
🚀 Starting data_iter_step 45 (DataLoader iteration took 0.637s)...
🚀 Starting data_iter_step 46 (DataLoader iteration took 0.645s)...
🚀 Starting data_iter_step 47 (DataLoader iteration took 0.667s)...
🚀 Starting data_iter_step 48 (DataLoader iteration took 0.624s)...
🚀 Starting data_iter_step 49 (DataLoader iteration took 5.244s)...
🚀 Starting data_iter_step 50 (DataLoader iteration took 0.405s)...
Epoch: [1] [50/78] eta: 0:00:17 loss: 6.9688 lr: 0.000328 time: 0.6166 data: 0.4051
🚀 Starting data_iter_step 51 (DataLoader iteration took 0.263s)...
🚀 Starting data_iter_step 52 (DataLoader iteration took 0.649s)...
🚀 Starting data_iter_step 53 (DataLoader iteration took 0.196s)...
🚀 Starting data_iter_step 54 (DataLoader iteration took 0.381s)...
🚀 Starting data_iter_step 55 (DataLoader iteration took 0.333s)...
🚀 Starting data_iter_step 56 (DataLoader iteration took 0.655s)...
🚀 Starting data_iter_step 57 (DataLoader iteration took 5.255s)...
🚀 Starting data_iter_step 58 (DataLoader iteration took 0.267s)...
🚀 Starting data_iter_step 59 (DataLoader iteration took 0.213s)...
🚀 Starting data_iter_step 60 (DataLoader iteration took 0.674s)...
Epoch: [1] [60/78] eta: 0:00:04 loss: 6.9375 lr: 0.000354 time: 0.2657 data: 0.6737
🚀 Starting data_iter_step 61 (DataLoader iteration took 0.658s)...
🚀 Starting data_iter_step 62 (DataLoader iteration took 0.230s)...
🚀 Starting data_iter_step 63 (DataLoader iteration took 0.600s)...
🚀 Starting data_iter_step 64 (DataLoader iteration took 0.623s)...
🚀 Starting data_iter_step 65 (DataLoader iteration took 5.903s)...
🚀 Starting data_iter_step 66 (DataLoader iteration took 0.301s)...
🚀 Starting data_iter_step 67 (DataLoader iteration took 0.375s)...
🚀 Starting data_iter_step 68 (DataLoader iteration took 0.551s)...
🚀 Starting data_iter_step 69 (DataLoader iteration took 0.615s)...
🚀 Starting data_iter_step 70 (DataLoader iteration took 0.447s)...
Epoch: [1] [70/78] eta: 0:00:01 loss: 6.9062 lr: 0.000380 time: 0.2095 data: 0.4474
🚀 Starting data_iter_step 71 (DataLoader iteration took 0.658s)...
🚀 Starting data_iter_step 72 (DataLoader iteration took 0.378s)...
🚀 Starting data_iter_step 73 (DataLoader iteration took 3.170s)...
🚀 Starting data_iter_step 74 (DataLoader iteration took 0.304s)...
🚀 Starting data_iter_step 75 (DataLoader iteration took 0.321s)...
🚀 Starting data_iter_step 76 (DataLoader iteration took 0.292s)...
🚀 Starting data_iter_step 77 (DataLoader iteration took 0.571s)...
Averaged stats: loss: 6.9375 (6.9231)  lr: 0.0004 (0.0003)
🏁 train_one_epoch total time: 370.56s
✅ Training epoch 1 completed in 370.56s
Checking checkpoint save conditions...
About to start validation...
Getting eval model...
About to call evaluate()...
Starting validation loop...
Validation DataLoader type: <class 'torch_xla.distributed.parallel_loader.MpDeviceLoader'>
Validation DataLoader batch count: 3
About to call enumerate(metric_logger.log_every(...)) for validation...
TPU mode: Using direct validation DataLoader enumeration to avoid metric_logger overhead
📊 First validation enumerate() call took 93.58s
🔍 Starting validation batch 0 (DataLoader iteration took 468.906s)...
Test: [0/3] loss: 6.8750 acc1: 0.0000 acc5: 1.0391 time: 0.0868 data: 468.9064
* Acc@1 0.302 Acc@5 1.408 loss 6.792
✅ Validation completed in 94.60s
Accuracy of the model on the 50000 test images: 0.3%
Max accuracy: 0.30%
🏁 Epoch 1 total time: 465.17s
Starting epoch 2 (delay since last epoch: 0.00s)...
Setting sampler epoch...
About to call original_train_sampler.set_epoch(2)...
✅ original_train_sampler.set_epoch(2) completed in 0.00s
Setting wandb steps...
About to call train_one_epoch...
🎯 train_one_epoch called for epoch 2
About to zero_grad optimizer...
About to start data loader loop...
TPU mode: Using direct DataLoader enumeration to avoid metric_logger overhead
